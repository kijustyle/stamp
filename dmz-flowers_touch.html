<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>ì² ì±… ë„ˆë¨¸ë¡œ í™œì§ í”¼ëŠ” ê½ƒ (ì„¼í„°-ì•„ì›ƒ)</title>
<style>
  :root{
    --target-min: 9;   /* ëª©í‘œ ìµœì†Œ */
    --target-max: 11;  /* ëª©í‘œ ìµœëŒ€ */
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{height:100%;margin:0}
  body{background:#0b0f12;font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans KR",sans-serif}

  /* ë¬´ëŒ€: ë°°ê²½ ì´ë¯¸ì§€ë¥¼ ê½‰ ì±„ìš°ê¸° */
  .stage{
    position:fixed; inset:0;
    background:#000 url("img/flowers_bg.png") center/cover no-repeat;
    overflow:hidden;
  }

  /* ê½ƒì„ ì–¹ì„ ë ˆì´ì–´ (SVG) */
  svg#overlay{position:absolute; inset:0; width:100%; height:100%; display:block}

  /* HUD / ì™„ë£Œ */
  .hud{
    position:absolute; top:10px; right:10px; z-index:10;
    background:#111827cc; color:#fff; padding:6px 10px; font-size:12px;
    border-radius:999px; pointer-events:none;
  }
  .hint{
    position:absolute; left:50%; transform:translateX(-50%);
    bottom:10px; z-index:10;
    background:#ffffffee; border:1px solid #e5e7eb; color:#111827;
    padding:6px 10px; font-size:13px; border-radius:10px; backdrop-filter:blur(6px)
  }
  .complete{
    position:absolute; inset:0; z-index:12; display:none; place-items:center;
    background:rgba(255,255,255,.55); backdrop-filter:blur(6px);
  }
  .complete h2{
    margin:0; padding:12px 18px; border-radius:14px; font-size:20px;
    background:#d1fae5; color:#065f46; border:1px solid #10b981;
    box-shadow:0 10px 25px rgba(0,0,0,.15);
  }

  @media (prefers-reduced-motion: reduce){ .hint{display:none} }
</style>
</head>
<body>
<div class="stage" id="stage" aria-label="ì² ì±… ë„ˆë¨¸ë¡œ í™œì§ í”¼ëŠ” ê½ƒ">
  <div class="hud"><span id="progress">0 / ?</span></div>
  <div class="hint">í™”ë©´ì„ íƒ­í•˜ë©´ ê½ƒì´ ì¤‘ì‹¬ì—ì„œ í¼ì§€ë©° í”¼ì–´ìš” ğŸŒ¹</div>

  <!-- ê½ƒì„ ì–¹ëŠ” SVG -->
  <svg id="overlay" xmlns="http://www.w3.org/2000/svg" role="img" aria-hidden="true">
    <defs>
      <!-- ë¶€ë“œëŸ¬ìš´ ê·¸ë¦¼ì -->
      <filter id="softShadow" x="-30%" y="-30%" width="160%" height="160%">
        <feDropShadow dx="0" dy="4" stdDeviation="3.2" flood-color="#000" flood-opacity="0.35"/>
      </filter>
    </defs>
    <g id="flowers"></g>
  </svg>

  <!-- ì½˜í˜í‹° -->
  <canvas id="fx" style="position:absolute;inset:0;pointer-events:none;z-index:11"></canvas>

  <div class="complete" id="complete"><h2>ì™„ë£Œ! í‰í™”ì˜ ê½ƒì´ ë§Œê°œí–ˆì–´ìš”</h2></div>
</div>

<script>
(function(){
  const stage = document.getElementById('stage');
  const svg   = document.getElementById('overlay');
  const layer = document.getElementById('flowers');
  const hud   = document.getElementById('progress');
  const done  = document.getElementById('complete');

  const fx = document.getElementById('fx');
  const ctx = fx.getContext('2d');

  // ëª©í‘œ ê°œìˆ˜ ë¬´ì‘ìœ„ (9~11)
  const TARGET = randInt(getCss('--target-min', 9), getCss('--target-max', 11));
  let opened = 0;
  hud.textContent = `${opened} / ${TARGET}`;

  // ë„¤ê°€ ì œê³µí•œ 4ê°œì˜ ê½ƒ ì´ë¯¸ì§€ ê²½ë¡œ
  const FLOWER_SOURCES = [
    'img/flower_1.png',
    'img/flower_2.png',
    'img/flower_3.png',
    'img/flower_4.png'
  ];
  let imagePool = [];

  // ìº”ë²„ìŠ¤ ë¦¬ì‚¬ì´ì¦ˆ
  function resizeFX(){
    fx.width  = stage.clientWidth * devicePixelRatio;
    fx.height = stage.clientHeight * devicePixelRatio;
    fx.style.width  = stage.clientWidth + 'px';
    fx.style.height = stage.clientHeight + 'px';
  }
  window.addEventListener('resize', resizeFX, {passive:true});
  resizeFX();

  // CSS ë³€ìˆ˜ ìˆ«ì ì½ê¸°
  function getCss(name, fallback){
    const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    const n = Number(v); return Number.isFinite(n) ? n : fallback;
  }
  function rand(min,max){ return Math.random()*(max-min)+min; }
  function randInt(min,max){ return Math.floor(rand(min,max+1)); }

  // í¬ì¸í„° ì¢Œí‘œ -> SVG ì¢Œí‘œ
  function toSVGPoint(x,y){
    const pt = new DOMPoint(x,y);
    const ctm = svg.getScreenCTM().inverse();
    return pt.matrixTransform(ctm);
  }

  // ===== ì´ë¯¸ì§€ í”„ë¦¬ë¡œë“œ =====
  Promise.allSettled(
    FLOWER_SOURCES.map(src => new Promise(res=>{
      const im = new Image();
      im.onload = ()=>res({ok:true, img:im});
      im.onerror = ()=>res({ok:false});
      im.src = src;
    }))
  ).then(results=>{
    imagePool = results.filter(r=>r.value && r.value.ok).map(r=>r.value.img);
  });

  // ===== ì„¼í„°-ì•„ì›ƒ ê°œí™”: ë§ˆìŠ¤í¬+ìŠ¤ì¼€ì¼ ì• ë‹ˆë©”ì´ì…˜ =====
  function plantAt(clientX, clientY){
    if(opened >= TARGET) return;
    if(imagePool.length === 0) return; // ì´ë¯¸ì§€ ì¤€ë¹„ ì „ íƒ­ ë°©ì§€

    const p = toSVGPoint(clientX, clientY);
    const pick = imagePool[randInt(0, imagePool.length-1)];

    // ê·¸ë£¹ ìƒì„±
    const g = document.createElementNS('http://www.w3.org/2000/svg','g');
    g.setAttribute('filter','url(#softShadow)');
    layer.appendChild(g);

    // ê³ ì • ê¸°ì¤€ í¬ê¸°(ì´ë¯¸ì§€ ì‹¤ì œ í¬ê¸°ì™€ ë¬´ê´€í•˜ê²Œ í™”ë©´ ê¸°ì¤€ìœ¼ë¡œ í†µì¼)
    const base = rand(80, 120);       // ê¸°ì¡´ 120~170 â†’ 80~120
    const scaleTarget = rand(0.7, 1.0); // ê¸°ì¡´ 0.95~1.25 â†’ 0.7~1.0
    const rot   = rand(-8, 8);

    // ì´ë¯¸ì§€ ë…¸ë“œ
    const img = document.createElementNS('http://www.w3.org/2000/svg','image');
    img.setAttributeNS('http://www.w3.org/1999/xlink','href', pick.src);
    img.setAttribute('width', base);
    img.setAttribute('height', base);
    img.setAttribute('x', -base/2);
    img.setAttribute('y', -base/2);
    img.setAttribute('preserveAspectRatio','xMidYMid meet');

    // ë§ˆìŠ¤í¬(ì›í˜•) - ì¤‘ì‹¬ì—ì„œ ë°˜ê²½ì´ ì»¤ì§€ë©° ë“œëŸ¬ë‚¨
    const maskId = 'm' + Math.random().toString(36).slice(2);
    const mask = document.createElementNS('http://www.w3.org/2000/svg','mask');
    mask.setAttribute('id', maskId);

    const maskCircle = document.createElementNS('http://www.w3.org/2000/svg','circle');
    maskCircle.setAttribute('cx','0');
    maskCircle.setAttribute('cy','0');
    maskCircle.setAttribute('r','0');            // ì‹œì‘ì€ 0
    maskCircle.setAttribute('fill','#fff');      // í°ìƒ‰=ë³´ì´ëŠ” ì˜ì—­
    mask.appendChild(maskCircle);
    svg.querySelector('defs')?.appendChild(mask) || (()=>{ // defs ì—†ìœ¼ë©´ ë§Œë“ ë‹¤
      const defs = document.createElementNS('http://www.w3.org/2000/svg','defs');
      svg.prepend(defs); defs.appendChild(mask);
    })();

    // ì´ë¯¸ì§€ì— ë§ˆìŠ¤í¬ ì ìš©
    img.setAttribute('mask', `url(#${maskId})`);
    g.appendChild(img);

    // ì´ˆê¸° íŠ¸ëœìŠ¤í¼(opacity 0, ì•„ì£¼ ì‘ê²Œ)
    g.style.opacity = '0';
    g.setAttribute('transform', `translate(${p.x},${p.y}) scale(0.15) rotate(${rot})`);

    // ì• ë‹ˆë©”ì´ì…˜: 1) ë¶ˆíˆ¬ëª…ë„, 2) ìŠ¤ì¼€ì¼(ì„¼í„°-ì•„ì›ƒ), 3) ë§ˆìŠ¤í¬ ë°˜ê²½ í™•ì¥
    const D_OPA = 220;    // opacity íŠ¸ëœì§€ì…˜(ms)
    const D_SCL = 680;    // scale íŠ¸ëœì§€ì…˜(ms)
    const D_MSK = 700;    // ë§ˆìŠ¤í¬ ë°˜ê²½ í™•ì¥(ms)
    const rTarget = Math.sqrt((base/2)**2 + (base/2)**2); // ì´ë¯¸ì§€ ëŒ€ê°ì„  ë°˜ ì •ë„ â†’ ì¶©ë¶„íˆ ì»¤ì§€ê²Œ

    // opacity + scale easing
    requestAnimationFrame(()=>{
      g.style.transition = `opacity ${D_OPA}ms ease, transform ${D_SCL}ms cubic-bezier(.2,1.2,.2,1)`;
      g.style.opacity = '1';
      g.setAttribute('transform', `translate(${p.x},${p.y}) scale(${scaleTarget*1.03}) rotate(${rot})`);
      setTimeout(()=>{
        g.setAttribute('transform', `translate(${p.x},${p.y}) scale(${scaleTarget}) rotate(${rot})`);
      }, D_SCL);
    });

    // ë§ˆìŠ¤í¬ ë°˜ê²½ì€ JSë¡œ ë¶€ë“œëŸ½ê²Œ í™•ëŒ€
    const t0 = performance.now();
    (function growMask(now){
      const t = Math.min(1, (now - t0) / D_MSK);
      const ease = t<0.5 ? 2*t*t : -1+(4-2*t)*t; // ì•½í•œ easeInOut
      const r = rTarget * ease;
      maskCircle.setAttribute('r', String(r));
      if(t < 1) requestAnimationFrame(growMask);
    })(t0);

    // ë¯¸ì„¸ í”ë“¤ë¦¼(ìì—°ìŠ¤ëŸ¬ì›€)
    sway(g, p.x, p.y, scaleTarget, rot);

    // ì§„í–‰/ì™„ë£Œ
    opened += 1;
    hud.textContent = `${opened} / ${TARGET}`;
    if (opened >= TARGET) setTimeout(complete, 750);
  }

  // ë¯¸ì„¸ í”ë“¤ë¦¼
  function sway(node, x, y, scale, rot){
    const phase = Math.random()*Math.PI*2;
    (function loop(){
      if (!document.body.contains(node)) return;
      const t = performance.now()/1000 + phase;
      const dx = Math.sin(t*0.7)*1.2;
      const dy = Math.cos(t*0.9)*0.8;
      node.setAttribute('transform',`translate(${x+dx},${y+dy}) scale(${scale}) rotate(${rot})`);
      requestAnimationFrame(loop);
    })();
  }

  // ì™„ë£Œ ì²˜ë¦¬
  function complete(){
    stage.removeEventListener('pointerdown', onDown);
    document.getElementById('complete').style.display='grid';
    confetti();
    // ì™¸ë¶€ ì—°ë™ ì´ë²¤íŠ¸/ì½œë°±
    stage.dispatchEvent(new CustomEvent('garden:complete', {detail:{ total: opened, target: TARGET }}));
    if (typeof window.onGardenComplete === 'function'){
      window.onGardenComplete({ total: opened, target: TARGET });
    }
  }

  // ì…ë ¥ ì²˜ë¦¬
  function onDown(e){
    const p = (e.touches && e.touches[0]) || e;
    plantAt(p.clientX, p.clientY);
  }
  stage.addEventListener('pointerdown', onDown);

  // ê°„ë‹¨ ì½˜í˜í‹°
  function confetti(){
    resizeFX();
    const pieces=[];
    for(let i=0;i<700;i++){
      pieces.push({
        x: fx.width/2 + (Math.random()*80-40),
        y: fx.height*0.55,
        vx: Math.random()*6-3,
        vy: - (4+Math.random()*5),
        g: 0.08 + Math.random()*0.08,
        s: 2 + Math.random()*2,
        a: 1,
        r: Math.random()*Math.PI
      });
    }
    function step(){
      ctx.clearRect(0,0,fx.width,fx.height);
      for(const p of pieces){
        p.vy += p.g; p.x += p.vx; p.y += p.vy; p.r += 0.1; p.a -= 0.007;
        ctx.globalAlpha = Math.max(0,p.a);
        ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.r);
        ctx.fillRect(-p.s/2,-p.s/2,p.s,p.s); ctx.restore();
      }
      ctx.globalAlpha = 1;
      if (pieces.some(p=>p.a>0 && p.y<fx.height+20)) requestAnimationFrame(step);
    }
    step();
    setTimeout(()=>ctx.clearRect(0,0,fx.width,fx.height), 2600);
  }

  // ìœ í‹¸
  function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

})();
</script>
</body>
</html>
