<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MindAR 단일 타겟 테스트 (수정됨)</title>
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <style>
    html, body {
      margin: 0;
      height: 100%;
      overflow: hidden;
    }
    
    a-scene {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    
    #startBtn {
      position: fixed;
      left: 50%;
      bottom: 30px;
      transform: translateX(-50%);
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      background: #4CAF50;
      color: white;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      z-index: 10001;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    
    #startBtn:hover {
      background: #45a049;
    }
    
    #msg {
      position: fixed;
      left: 10px;
      top: 10px;
      right: 10px;
      padding: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: #0ff;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.5;
      z-index: 10002;
      border-radius: 5px;
      max-height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    
    .loading-spinner {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: none;
      z-index: 10000;
    }
    
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid #4CAF50;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="msg">🔄 초기화 중...</div>
  <button id="startBtn">📷 AR 카메라 시작</button>
  <div class="loading-spinner" id="spinner">
    <div class="spinner"></div>
  </div>

  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    renderer="logarithmicDepthBuffer: true; colorManagement: true; sortObjects: true; physicallyCorrectLights: false; maxCanvasWidth: 1920; maxCanvasHeight: 1920"
    mindar-image="imageTargetSrc: targets/hidden-land.mind; maxTrack: 1; autostart: false; filterMinCF: 0.0001; filterBeta: 0.001; warmupTolerance: 5; missTolerance: 5">
    
    <a-assets>
      <!-- 에셋 프리로드 (필요시) -->
    </a-assets>
    
    <!-- 타겟 0: 감지 테스트용 3D 객체들 -->
    <a-entity id="target0" mindar-image-target="targetIndex: 0">
      <!-- 메인 박스 -->
      <a-box 
        id="mainBox"
        position="0 0 0" 
        rotation="0 45 0"
        width="0.15" 
        height="0.15" 
        depth="0.15" 
        color="#4CAF50"
        animation="property: rotation; to: 0 405 0; dur: 3000; loop: true; easing: linear">
      </a-box>
      
      <!-- 보조 구체 (위치 확인용) -->
      <a-sphere 
        position="0 0.2 0" 
        radius="0.05" 
        color="#FF5722"
        animation="property: position; to: 0 0.3 0; dur: 1000; dir: alternate; loop: true; easing: easeInOutQuad">
      </a-sphere>
      
      <!-- 텍스트 라벨 -->
      <a-text 
        value="Target Found!" 
        position="0 -0.2 0" 
        align="center" 
        color="#FFFFFF"
        scale="0.5 0.5 0.5">
      </a-text>
    </a-entity>
    
    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
  </a-scene>

  <script>
    // 로깅 헬퍼
    const msgEl = document.getElementById('msg');
    const startBtn = document.getElementById('startBtn');
    const spinner = document.getElementById('spinner');
    let logBuffer = [];
    
    function log(prefix, ...args) {
      const timestamp = new Date().toLocaleTimeString('ko-KR', { 
        hour12: false, 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit',
        fractionalSecondDigits: 3 
      });
      const logMsg = `[${timestamp}] ${prefix}: ${args.join(' ')}`;
      console.log(logMsg);
      logBuffer.push(logMsg);
      
      // 최근 10개 로그만 표시
      if (logBuffer.length > 10) {
        logBuffer.shift();
      }
      msgEl.textContent = logBuffer.join('\n');
    }
    
    // 1. 환경 체크
    log('ENV', `Protocol: ${location.protocol}, Secure: ${window.isSecureContext}`);
    
    if (!window.isSecureContext && location.hostname !== 'localhost') {
      log('⚠️', 'HTTPS가 아닙니다. 카메라 접근이 차단될 수 있습니다.');
      alert('HTTPS 연결이 필요합니다. 카메라가 작동하지 않을 수 있습니다.');
    }
    
    // 2. 브라우저 호환성 체크
    const checkBrowserCompatibility = () => {
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
      const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
      
      if (isIOS && !isSafari) {
        log('⚠️', 'iOS에서는 Safari를 권장합니다.');
      }
      
      log('BROWSER', `iOS: ${isIOS}, Safari: ${isSafari}, Chrome: ${isChrome}`);
      
      // WebRTC 지원 체크
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        log('❌', 'WebRTC가 지원되지 않습니다.');
        alert('이 브라우저는 카메라를 지원하지 않습니다.');
        return false;
      }
      
      return true;
    };
    
    // 3. .mind 파일 확인
    const checkMindFile = async () => {
      try {
        const response = await fetch('targets/hidden-land.mind');
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const blob = await response.blob();
        log('MIND', `파일 로드 성공 (${(blob.size / 1024).toFixed(2)} KB)`);
        return true;
      } catch (error) {
        log('❌', `MIND 파일 로드 실패: ${error.message}`);
        alert('targets/hidden-land.mind 파일을 찾을 수 없습니다.\n경로를 확인해주세요.');
        return false;
      }
    };
    
    // 4. A-Frame & MindAR 이벤트 설정
    const sceneEl = document.querySelector('a-scene');
    const targetEl = document.getElementById('target0');
    
    // Scene 이벤트
    sceneEl.addEventListener('loaded', () => {
      log('A-FRAME', 'Scene loaded');
    });
    
    // MindAR 시스템 이벤트
    sceneEl.addEventListener('arReady', () => {
      log('MINDAR', '✅ AR Ready');
      spinner.style.display = 'none';
    });
    
    sceneEl.addEventListener('arError', (event) => {
      log('❌', `AR Error: ${event.detail || 'Unknown error'}`);
      spinner.style.display = 'none';
      alert('AR 초기화 실패. 카메라 권한을 확인해주세요.');
    });
    
    // 타겟 이벤트
    let foundCount = 0;
    let lostCount = 0;
    
    targetEl.addEventListener('targetFound', () => {
      foundCount++;
      log('🎯', `Target Found! (횟수: ${foundCount})`);
      msgEl.style.background = 'rgba(0, 255, 0, 0.8)';
      setTimeout(() => {
        msgEl.style.background = 'rgba(0, 0, 0, 0.8)';
      }, 500);
    });
    
    targetEl.addEventListener('targetLost', () => {
      lostCount++;
      log('👻', `Target Lost (횟수: ${lostCount})`);
      msgEl.style.background = 'rgba(255, 0, 0, 0.8)';
      setTimeout(() => {
        msgEl.style.background = 'rgba(0, 0, 0, 0.8)';
      }, 500);
    });
    
    // 5. 수동 시작 버튼
    startBtn.addEventListener('click', async () => {
      try {
        // 환경 체크
        if (!checkBrowserCompatibility()) {
          return;
        }
        
        // MIND 파일 체크
        const mindFileExists = await checkMindFile();
        if (!mindFileExists) {
          return;
        }
        
        // 카메라 권한 먼저 요청
        log('CAMERA', '권한 요청 중...');
        spinner.style.display = 'block';
        
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
              facingMode: 'environment',
              width: { ideal: 1280 },
              height: { ideal: 720 }
            } 
          });
          
          log('CAMERA', '✅ 권한 획득');
          
          // 스트림 정지 (MindAR이 다시 열 것임)
          stream.getTracks().forEach(track => track.stop());
          
        } catch (cameraError) {
          log('❌', `카메라 권한 거부: ${cameraError.message}`);
          spinner.style.display = 'none';
          alert('카메라 권한이 필요합니다.');
          return;
        }
        
        // MindAR 시작
        log('MINDAR', 'Starting AR system...');
        const mindSystem = sceneEl.systems['mindar-image-system'];
        
        if (!mindSystem) {
          throw new Error('MindAR system not found');
        }
        
        await mindSystem.start();
        
        log('MINDAR', '✅ AR Started Successfully');
        startBtn.style.display = 'none';
        spinner.style.display = 'none';
        
        // 안내 메시지
        setTimeout(() => {
          log('📱', '타겟 이미지를 카메라에 비춰주세요');
        }, 1000);
        
      } catch (error) {
        console.error('Start error:', error);
        log('❌', `시작 실패: ${error.message}`);
        spinner.style.display = 'none';
        
        // 상세한 에러 메시지
        let errorMsg = 'AR 시작 실패:\n';
        if (error.message.includes('Permission')) {
          errorMsg += '카메라 권한을 허용해주세요.';
        } else if (error.message.includes('NotFound')) {
          errorMsg += '카메라를 찾을 수 없습니다.';
        } else if (error.message.includes('NotAllowed')) {
          errorMsg += '카메라가 차단되었습니다. 브라우저 설정을 확인하세요.';
        } else {
          errorMsg += error.message;
        }
        alert(errorMsg);
      }
    });
    
    // 6. 초기화 완료
    window.addEventListener('load', () => {
      log('INIT', '✅ 페이지 로드 완료');
      log('📌', 'AR 카메라 시작 버튼을 누르세요');
    });
    
    // 7. 디버깅용 전역 객체
    window.debugAR = {
      scene: sceneEl,
      target: targetEl,
      getLogs: () => logBuffer,
      getStats: () => ({
        foundCount,
        lostCount,
        isSecure: window.isSecureContext,
        protocol: location.protocol
      })
    };
  </script>
</body>
</html>