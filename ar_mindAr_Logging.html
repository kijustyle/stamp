<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MindAR ë‹¨ì¼ íƒ€ê²Ÿ í…ŒìŠ¤íŠ¸ (ìˆ˜ì •ë¨)</title>
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <style>
    html, body {
      margin: 0;
      height: 100%;
      overflow: hidden;
    }
    
    a-scene {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    
    #startBtn {
      position: fixed;
      left: 50%;
      bottom: 30px;
      transform: translateX(-50%);
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      background: #4CAF50;
      color: white;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      z-index: 10001;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    
    #startBtn:hover {
      background: #45a049;
    }
    
    #msg {
      position: fixed;
      left: 10px;
      top: 10px;
      right: 10px;
      padding: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: #0ff;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.5;
      z-index: 10002;
      border-radius: 5px;
      max-height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    
    .loading-spinner {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: none;
      z-index: 10000;
    }
    
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid #4CAF50;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="msg">ğŸ”„ ì´ˆê¸°í™” ì¤‘...</div>
  <button id="startBtn">ğŸ“· AR ì¹´ë©”ë¼ ì‹œì‘</button>
  <div class="loading-spinner" id="spinner">
    <div class="spinner"></div>
  </div>

  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    renderer="logarithmicDepthBuffer: true; colorManagement: true; sortObjects: true; physicallyCorrectLights: false; maxCanvasWidth: 1920; maxCanvasHeight: 1920"
    mindar-image="imageTargetSrc: targets/hidden-land.mind; maxTrack: 1; autostart: false; filterMinCF: 0.0001; filterBeta: 0.001; warmupTolerance: 5; missTolerance: 5">
    
    <a-assets>
      <!-- ì—ì…‹ í”„ë¦¬ë¡œë“œ (í•„ìš”ì‹œ) -->
    </a-assets>
    
    <!-- íƒ€ê²Ÿ 0: ê°ì§€ í…ŒìŠ¤íŠ¸ìš© 3D ê°ì²´ë“¤ -->
    <a-entity id="target0" mindar-image-target="targetIndex: 0">
      <!-- ë©”ì¸ ë°•ìŠ¤ -->
      <a-box 
        id="mainBox"
        position="0 0 0" 
        rotation="0 45 0"
        width="0.15" 
        height="0.15" 
        depth="0.15" 
        color="#4CAF50"
        animation="property: rotation; to: 0 405 0; dur: 3000; loop: true; easing: linear">
      </a-box>
      
      <!-- ë³´ì¡° êµ¬ì²´ (ìœ„ì¹˜ í™•ì¸ìš©) -->
      <a-sphere 
        position="0 0.2 0" 
        radius="0.05" 
        color="#FF5722"
        animation="property: position; to: 0 0.3 0; dur: 1000; dir: alternate; loop: true; easing: easeInOutQuad">
      </a-sphere>
      
      <!-- í…ìŠ¤íŠ¸ ë¼ë²¨ -->
      <a-text 
        value="Target Found!" 
        position="0 -0.2 0" 
        align="center" 
        color="#FFFFFF"
        scale="0.5 0.5 0.5">
      </a-text>
    </a-entity>
    
    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
  </a-scene>

  <script>
    // ë¡œê¹… í—¬í¼
    const msgEl = document.getElementById('msg');
    const startBtn = document.getElementById('startBtn');
    const spinner = document.getElementById('spinner');
    let logBuffer = [];
    
    function log(prefix, ...args) {
      const timestamp = new Date().toLocaleTimeString('ko-KR', { 
        hour12: false, 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit',
        fractionalSecondDigits: 3 
      });
      const logMsg = `[${timestamp}] ${prefix}: ${args.join(' ')}`;
      console.log(logMsg);
      logBuffer.push(logMsg);
      
      // ìµœê·¼ 10ê°œ ë¡œê·¸ë§Œ í‘œì‹œ
      if (logBuffer.length > 10) {
        logBuffer.shift();
      }
      msgEl.textContent = logBuffer.join('\n');
    }
    
    // 1. í™˜ê²½ ì²´í¬
    log('ENV', `Protocol: ${location.protocol}, Secure: ${window.isSecureContext}`);
    
    if (!window.isSecureContext && location.hostname !== 'localhost') {
      log('âš ï¸', 'HTTPSê°€ ì•„ë‹™ë‹ˆë‹¤. ì¹´ë©”ë¼ ì ‘ê·¼ì´ ì°¨ë‹¨ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
      alert('HTTPS ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤. ì¹´ë©”ë¼ê°€ ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
    }
    
    // 2. ë¸Œë¼ìš°ì € í˜¸í™˜ì„± ì²´í¬
    const checkBrowserCompatibility = () => {
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
      const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
      
      if (isIOS && !isSafari) {
        log('âš ï¸', 'iOSì—ì„œëŠ” Safarië¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.');
      }
      
      log('BROWSER', `iOS: ${isIOS}, Safari: ${isSafari}, Chrome: ${isChrome}`);
      
      // WebRTC ì§€ì› ì²´í¬
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        log('âŒ', 'WebRTCê°€ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ì¹´ë©”ë¼ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return false;
      }
      
      return true;
    };
    
    // 3. .mind íŒŒì¼ í™•ì¸
    const checkMindFile = async () => {
      try {
        const response = await fetch('targets/hidden-land.mind');
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const blob = await response.blob();
        log('MIND', `íŒŒì¼ ë¡œë“œ ì„±ê³µ (${(blob.size / 1024).toFixed(2)} KB)`);
        return true;
      } catch (error) {
        log('âŒ', `MIND íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
        alert('targets/hidden-land.mind íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nê²½ë¡œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
        return false;
      }
    };
    
    // 4. A-Frame & MindAR ì´ë²¤íŠ¸ ì„¤ì •
    const sceneEl = document.querySelector('a-scene');
    const targetEl = document.getElementById('target0');
    
    // Scene ì´ë²¤íŠ¸
    sceneEl.addEventListener('loaded', () => {
      log('A-FRAME', 'Scene loaded');
    });
    
    // MindAR ì‹œìŠ¤í…œ ì´ë²¤íŠ¸
    sceneEl.addEventListener('arReady', () => {
      log('MINDAR', 'âœ… AR Ready');
      spinner.style.display = 'none';
    });
    
    sceneEl.addEventListener('arError', (event) => {
      log('âŒ', `AR Error: ${event.detail || 'Unknown error'}`);
      spinner.style.display = 'none';
      alert('AR ì´ˆê¸°í™” ì‹¤íŒ¨. ì¹´ë©”ë¼ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
    });
    
    // íƒ€ê²Ÿ ì´ë²¤íŠ¸
    let foundCount = 0;
    let lostCount = 0;
    
    targetEl.addEventListener('targetFound', () => {
      foundCount++;
      log('ğŸ¯', `Target Found! (íšŸìˆ˜: ${foundCount})`);
      msgEl.style.background = 'rgba(0, 255, 0, 0.8)';
      setTimeout(() => {
        msgEl.style.background = 'rgba(0, 0, 0, 0.8)';
      }, 500);
    });
    
    targetEl.addEventListener('targetLost', () => {
      lostCount++;
      log('ğŸ‘»', `Target Lost (íšŸìˆ˜: ${lostCount})`);
      msgEl.style.background = 'rgba(255, 0, 0, 0.8)';
      setTimeout(() => {
        msgEl.style.background = 'rgba(0, 0, 0, 0.8)';
      }, 500);
    });
    
    // 5. ìˆ˜ë™ ì‹œì‘ ë²„íŠ¼
    startBtn.addEventListener('click', async () => {
      try {
        // í™˜ê²½ ì²´í¬
        if (!checkBrowserCompatibility()) {
          return;
        }
        
        // MIND íŒŒì¼ ì²´í¬
        const mindFileExists = await checkMindFile();
        if (!mindFileExists) {
          return;
        }
        
        // ì¹´ë©”ë¼ ê¶Œí•œ ë¨¼ì € ìš”ì²­
        log('CAMERA', 'ê¶Œí•œ ìš”ì²­ ì¤‘...');
        spinner.style.display = 'block';
        
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
              facingMode: 'environment',
              width: { ideal: 1280 },
              height: { ideal: 720 }
            } 
          });
          
          log('CAMERA', 'âœ… ê¶Œí•œ íšë“');
          
          // ìŠ¤íŠ¸ë¦¼ ì •ì§€ (MindARì´ ë‹¤ì‹œ ì—´ ê²ƒì„)
          stream.getTracks().forEach(track => track.stop());
          
        } catch (cameraError) {
          log('âŒ', `ì¹´ë©”ë¼ ê¶Œí•œ ê±°ë¶€: ${cameraError.message}`);
          spinner.style.display = 'none';
          alert('ì¹´ë©”ë¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
          return;
        }
        
        // MindAR ì‹œì‘
        log('MINDAR', 'Starting AR system...');
        const mindSystem = sceneEl.systems['mindar-image-system'];
        
        if (!mindSystem) {
          throw new Error('MindAR system not found');
        }
        
        await mindSystem.start();
        
        log('MINDAR', 'âœ… AR Started Successfully');
        startBtn.style.display = 'none';
        spinner.style.display = 'none';
        
        // ì•ˆë‚´ ë©”ì‹œì§€
        setTimeout(() => {
          log('ğŸ“±', 'íƒ€ê²Ÿ ì´ë¯¸ì§€ë¥¼ ì¹´ë©”ë¼ì— ë¹„ì¶°ì£¼ì„¸ìš”');
        }, 1000);
        
      } catch (error) {
        console.error('Start error:', error);
        log('âŒ', `ì‹œì‘ ì‹¤íŒ¨: ${error.message}`);
        spinner.style.display = 'none';
        
        // ìƒì„¸í•œ ì—ëŸ¬ ë©”ì‹œì§€
        let errorMsg = 'AR ì‹œì‘ ì‹¤íŒ¨:\n';
        if (error.message.includes('Permission')) {
          errorMsg += 'ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
        } else if (error.message.includes('NotFound')) {
          errorMsg += 'ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
        } else if (error.message.includes('NotAllowed')) {
          errorMsg += 'ì¹´ë©”ë¼ê°€ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.';
        } else {
          errorMsg += error.message;
        }
        alert(errorMsg);
      }
    });
    
    // 6. ì´ˆê¸°í™” ì™„ë£Œ
    window.addEventListener('load', () => {
      log('INIT', 'âœ… í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
      log('ğŸ“Œ', 'AR ì¹´ë©”ë¼ ì‹œì‘ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”');
    });
    
    // 7. ë””ë²„ê¹…ìš© ì „ì—­ ê°ì²´
    window.debugAR = {
      scene: sceneEl,
      target: targetEl,
      getLogs: () => logBuffer,
      getStats: () => ({
        foundCount,
        lostCount,
        isSecure: window.isSecureContext,
        protocol: location.protocol
      })
    };
  </script>
</body>
</html>